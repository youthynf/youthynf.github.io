---
title: Linux系统的内存管理
author: ynf
date: 2021-11-09 06:36:31 +0800
categories: [操作系统]
tags: [内存管理]
---

## 内存管理的发展过程

### DOS操作系统时代

磁盘操作系统（Disk Operating System），是早期个人计算机上的一类操作系统。DOS在IBM PC 兼容机市场中占有举足轻重的地位。可以直接操纵管理硬盘的文件，以DOS的形式运行。微软图形界面操作系统Windows NT问世以来，DOS是一个后台程序的形式出现的。名为Windows命令提示符。可以通过点击运行-CMD进入。

特点：它是一个单用户单任务操作系统，同一时间只能有一个进程在运行（也有一些特殊算法可以支持多进程）。

### Windows 9x

Windows 9x是指对Windows 95及Windows 98、Windows ME等以Windows 95作基础的微软操作系统的通称。

特点：允许多个进程装入内存，但这时候会引发两个问题：第一，内存空间有限，装载过多的进程时，内存不够用的问题怎么解决；第二，所有的进程加载到内存，如果都是对物理内存的直接访问，将会导致内存互相干扰，那么如何解决内存互相打扰问题？

<span style="color:red">为了解决这两个问题，诞生了现在的内存管理系统：分页装入、虚拟地址、软硬件结合寻址。</span>

## 理解分页、虚拟内存、软硬件结合寻址

### 分页（解决内存不够用问题）

内存中分成固定大小的页框（4K），把程序（硬盘上）分成4K大小的块，用到哪一块，加载那一块，加载的过程中，如果内存已经满了，会把最不常用的一块放到swap分区， 把最新的一块加载进来，这个就是著名的LRU算法。

> 什么是swap？
>
> swap space是磁盘上的一块区域，可以是一个分区，也可以是一个文件，或者是他们的组合。简单点说，当系统物理内存吃紧时，Linux会将内存中不常访问的数据保存到swap上，这样系统就有更多的物理内存为各个进程服务，而当系统需要访问swap上存储的内容时，再将swap上的数据加载到内存中，这就是我们常说的swap out和swap in。
>
> 什么是LRU算法？
>
> 1. LRU算法 LeetCode146题，头条要求手撕，阿里去年也要求手撕
> 2. Least Recently Used 最不常用
> 3. 哈希表（保证 查找操作O(1)） + 链表 （保证 排序操作和新增操作 O(1)））
> 4. 双向链表 （保证 左边指针 指向右边块）

### 虚拟内存（解决相互打扰问题）

历史背景：早在DOS、Win31系统时代，同一时间只能有一个进程在运行，并且进程可以直接操作物理内存，因此会发生进程互相干掉对方数据的情况，死机也是常有的事。

为了保证互不影响 ，设计者让进程工作在虚拟空间，程序中用到的空间地址不再是直接的物理地址，而是虚拟的地址，这样，A进程永远不可能访问到B进程的空间。

虚拟空间多大呢？寻址空间，如果是64位系统则寻址空间为2 ^ 64，比物理空间大很多 ，单位是byte。站在虚拟的角度，进程是独享整个系统和CPU，因为它们互不干扰，可以任意操作自己的虚拟空间。

接下来聊聊系统如何实现虚拟地址到物理地址的映射。

### 内存映射（软硬件结合寻址）

1. 偏移量 + 段的基地址 = 线性地址 （虚拟空间）；
2. 线性地址通过 OS（操作系统） + MMU（硬件 Memory Management Unit）找到对应的物理内存地址。

### 缺页中断：

需要用到页面内存中没有，产生缺页异常（中断），由内核处理并加载到内存。



## 延伸理解：ZGC

ZGC这个名字中的Z，并不是什么单词的缩写，这个垃圾回收器的英文名字就叫做Z Garbage Collector，是一款追求低延迟的垃圾回收器，在jdk11中被加入到垃圾回收器家族中，注意在这个版本中，它是具有实验性质的，如果想在生产中使用，建议使用更高版本的jdk。

该回收器使用的算法叫做Colored Pointer。最突出的特点是，GC信息记录在指针上，而不是记录在头部（mark work）中，好处是实现了 immediate memory use，也就是说此时修改对象的状态信息只需要直接在对象指针上修改即可，而不需要通过指针找到对象，然后再去修改对象的头部信息。

42位指针，寻址空间4T，JDK13扩展到16T，而目前为止最大16T，大约是2^44。

### CPU如何区分一个立即数 和 一条指令

总线内部分为：数据总线 地址总线 控制总线。其中地址总线目前：48位，而不是64位（已经足够大了，所以可以理解为节约成本）。颜色指针本质上包含了地址映射的概念。
